% Seção 5: Compliance Engine
% Verificação Automática de Requisitos Regulatórios

\section{Compliance Engine: Verificação Automática de Requisitos Regulatórios}
\label{sec:compliance}

Esta seção apresenta o \textit{Compliance Engine} do DeepBridge, o primeiro framework a automatizar verificação de conformidade com requisitos regulatórios (EEOC, ECOA, GDPR) sobre modelos de ML. Ao contrário de ferramentas existentes que calculam métricas acadêmicas mas deixam interpretação manual para equipes de compliance, DeepBridge verifica automaticamente se métricas atendem thresholds regulatórios e gera relatórios audit-ready. A Figura~\ref{fig:compliance_flow} ilustra o fluxo de verificação automática.

\input{figures/fig_compliance_flow}

% ========================================
% 5.1 Contexto Regulatório
% ========================================

\subsection{Contexto Regulatório}
\label{sec:compliance:context}

Modelos de ML em domínios de alto impacto (contratação, crédito, saúde) estão sujeitos a múltiplas regulamentações que impõem requisitos quantitativos sobre fairness e explicabilidade.

\subsubsection{EEOC (Equal Employment Opportunity Commission)}

A EEOC regula discriminação em processos de contratação nos Estados Unidos através de dois requisitos principais:

\paragraph{Regra dos 80\% (4/5ths Rule)}
Uniform Guidelines on Employee Selection Procedures (1978)~\cite{eeoc1978uniform} estabelecem que a taxa de seleção de um grupo protegido deve ser ao menos 80\% da taxa do grupo de maior seleção:

$$
\text{Disparate Impact} = \frac{P(\text{seleção} | \text{grupo protegido})}{P(\text{seleção} | \text{grupo referência})} \geq 0.80
$$

Se $\text{DI} < 0.80$, há \textit{prima facie} de discriminação e o empregador deve justificar a necessidade do negócio (\textit{business necessity}).

\paragraph{Questão 21 (Question 21)}
Requisito de representação mínima: cada grupo demográfico deve representar ao menos 2\% dos selecionados, exceto se representar $< 2\%$ da população aplicante.

Formalmente, para grupo $g$:
$$
\frac{n_{\text{selecionados}}^g}{n_{\text{selecionados}}^{\text{total}}} \geq \min\left(0.02, \frac{n_{\text{aplicantes}}^g}{n_{\text{aplicantes}}^{\text{total}}}\right)
$$

\subsubsection{ECOA (Equal Credit Opportunity Act)}

A ECOA (1974) proíbe discriminação em decisões de crédito e exige ``razões específicas'' (\textit{specific reasons}) para decisões adversas~\cite{ecoa1974equal}. Regulation B implementando ECOA requer:

\begin{itemize}
    \item \textbf{Adverse Action Notices}: Credores devem notificar aplicantes rejeitados com razões específicas (e.g., ``renda insuficiente'', ``histórico de crédito limitado'')
    \item \textbf{Prohibited Bases}: Decisões não podem ser baseadas em raça, cor, religião, nacionalidade, sexo, estado civil, idade
    \item \textbf{Disparate Impact Doctrine}: Mesmo políticas facialmente neutras são ilegais se têm impacto discriminatório sem justificativa de negócio
\end{itemize}

\subsubsection{GDPR Article 22 (União Europeia)}

O GDPR (2016) garante direito à explicação para decisões automatizadas com efeitos legais significativos~\cite{gdpr2016general}:

\begin{quote}
``The data subject shall have the right not to be subject to a decision based solely on automated processing [...] which produces legal effects concerning him or her [...] and to obtain human intervention, to express his or her point of view and to contest the decision.''
\end{quote}

Requisitos práticos:
\begin{itemize}
    \item \textbf{Right to Explanation}: Indivíduos podem solicitar explicações de decisões automatizadas
    \item \textbf{Meaningful Information}: Explicações devem ser ``meaningful'' sobre lógica do sistema
    \item \textbf{Human Review}: Possibilidade de revisão humana para decisões contestadas
\end{itemize}

% ========================================
% 5.2 Gap entre Métricas Acadêmicas e Requisitos Regulatórios
% ========================================

\subsection{Gap entre Métricas Acadêmicas e Requisitos Regulatórios}
\label{sec:compliance:gap}

Ferramentas existentes (AI Fairness 360, Fairlearn) calculam métricas acadêmicas mas não verificam compliance automaticamente. A Tabela~\ref{tab:compliance_gap} ilustra o gap.

\begin{table}[htbp]
\centering
\caption{Gap entre Ferramentas Existentes e Compliance}
\label{tab:compliance_gap}
\small
\begin{tabular}{lp{4cm}p{4cm}}
\toprule
\textbf{Requisito} & \textbf{Ferramentas Existentes} & \textbf{DeepBridge} \\
\midrule
EEOC 80\% Rule & Calcula DI, usuário verifica manualmente & Verifica $\text{DI} \geq 0.80$ automaticamente \\
EEOC Question 21 & Não implementado & Verifica representação $\geq 2\%$ por grupo \\
ECOA Adverse Action & Não suportado & Gera razões específicas via SHAP \\
GDPR Right to Explanation & Feature importance manual & Templates GDPR-compliant automáticos \\
\bottomrule
\end{tabular}
\end{table}

Este gap força equipes de compliance a:
\begin{itemize}
    \item Copiar métricas de notebooks para planilhas
    \item Verificar manualmente thresholds regulatórios
    \item Criar relatórios ad-hoc para auditorias
    \item Interpretar métricas técnicas para linguagem regulatória
\end{itemize}

Processo manual, propenso a erros e não escalável para validação contínua em produção.

% ========================================
% 5.3 Arquitetura do Compliance Engine
% ========================================

\subsection{Arquitetura do Compliance Engine}
\label{sec:compliance:architecture}

O \textit{Compliance Engine} do DeepBridge automatiza o fluxo de compliance através de três componentes:

\subsubsection{Regulation Registry}

Registro centralizado de requisitos regulatórios como regras verificáveis:

\begin{lstlisting}[language=Python, caption=Estrutura de regras de compliance]
class ComplianceRule:
    name: str                    # "EEOC 80% Rule"
    regulation: str              # "EEOC Uniform Guidelines 1978"
    jurisdiction: str            # "US"
    metric: str                  # "disparate_impact"
    threshold: float             # 0.80
    comparison: str              # ">=" ou "<=", "=="
    severity: str                # "CRITICAL", "WARNING", "INFO"
    documentation_url: str       # Link para regulacao

# Registro de regras built-in
COMPLIANCE_RULES = {
    'eeoc_80_rule': ComplianceRule(
        name="EEOC 80% Rule (4/5ths Rule)",
        regulation="29 CFR 1607.4D",
        jurisdiction="US",
        metric="disparate_impact",
        threshold=0.80,
        comparison=">=",
        severity="CRITICAL"
    ),
    'eeoc_question_21': ComplianceRule(
        name="EEOC Question 21 (2% Representation)",
        regulation="EEO-1 Component 1",
        jurisdiction="US",
        metric="group_representation",
        threshold=0.02,
        comparison=">=",
        severity="CRITICAL"
    ),
    # ... mais regras
}
\end{lstlisting}

Usuários podem adicionar regras customizadas:

\begin{lstlisting}[language=Python, caption=Adição de regras customizadas]
from deepbridge.compliance import ComplianceEngine, ComplianceRule

# Adicionar regra customizada (ex: regulacao local)
custom_rule = ComplianceRule(
    name="Brazil LGPD Article 20",
    regulation="Lei Geral de Protecao de Dados",
    jurisdiction="BR",
    metric="explainability_score",
    threshold=0.7,
    comparison=">=",
    severity="CRITICAL"
)

engine = ComplianceEngine()
engine.register_rule('lgpd_art20', custom_rule)
\end{lstlisting}

\subsubsection{Compliance Checker}

Verifica automaticamente se métricas atendem thresholds:

\begin{lstlisting}[language=Python, caption=Verificação automática de compliance]
from deepbridge import DBDataset, Experiment

# Executar validacao
dataset = DBDataset(data=df, target_column='hired', model=model,
                    protected_attributes=['gender', 'race', 'age'])
exp = Experiment(dataset, tests=['fairness'])
results = exp.run_tests()

# Verificar compliance automaticamente
compliance_report = exp.check_compliance(
    regulations=['eeoc', 'ecoa'],  # Selecionar regulacoes
    jurisdiction='US'
)

# Resultado estruturado
print(compliance_report.summary())
# ===== COMPLIANCE REPORT =====
# Jurisdiction: US
# Regulations Checked: EEOC, ECOA
#
# CRITICAL ISSUES: 1
# - EEOC 80% Rule: FAIL
#   Gender (Female): DI = 0.76 (threshold: 0.80)
#   Race (Black): DI = 0.73 (threshold: 0.80)
#
# WARNINGS: 0
#
# PASSED: 2
# - EEOC Question 21: PASS (all groups >= 2%)
# - ECOA Adverse Action: PASS (explanations available)
\end{lstlisting}

\subsubsection{Report Generator}

Gera relatórios formatados para auditorias:

\begin{lstlisting}[language=Python, caption=Geração de relatórios audit-ready]
# Gerar relatorio PDF completo
exp.save_compliance_report(
    output_path='compliance_audit_report.pdf',
    regulations=['eeoc', 'ecoa', 'gdpr'],
    include_sections=[
        'executive_summary',      # Resumo executivo
        'methodology',            # Metodologia de testes
        'detailed_results',       # Resultados detalhados
        'regulatory_mapping',     # Mapeamento metrica -> regulacao
        'recommendations',        # Recomendacoes de mitigacao
        'appendix'                # Dados tecnicos
    ],
    template='audit_ready'        # Template profissional
)
\end{lstlisting}

% ========================================
% 5.4 Verificação Multi-Jurisdicional
% ========================================

\subsection{Verificação Multi-Jurisdicional}
\label{sec:compliance:multijurisdictional}

DeepBridge suporta verificação simultânea de múltiplas jurisdições, crítico para empresas multinacionais:

\begin{lstlisting}[language=Python, caption=Compliance multi-jurisdicional]
# Verificar compliance em multiplas jurisdicoes
compliance_report = exp.check_compliance(
    jurisdictions=['US', 'EU', 'BR', 'CA']
)

# Resultado por jurisdicao
for jurisdiction, report in compliance_report.items():
    print(f"\n=== {jurisdiction} ===")
    print(f"Status: {report.overall_status}")
    print(f"Critical Issues: {len(report.critical_issues)}")
    print(f"Regulations: {', '.join(report.regulations_checked)}")
\end{lstlisting}

A Tabela~\ref{tab:multijurisdictional} mostra regulações suportadas por jurisdição.

\begin{table}[htbp]
\centering
\caption{Regulações Suportadas por Jurisdição}
\label{tab:multijurisdictional}
\small
\begin{tabular}{llp{5cm}}
\toprule
\textbf{Jurisdição} & \textbf{Regulação} & \textbf{Requisitos Verificados} \\
\midrule
US & EEOC & 80\% Rule, Question 21 \\
US & ECOA & Adverse Action Notices, Disparate Impact \\
US & FCRA & Adverse Action (crédito) \\
EU & GDPR & Article 22 (explicabilidade) \\
BR & LGPD & Article 20 (revisão humana) \\
CA & AIDA (proposta) & Transparency, Fairness \\
\bottomrule
\end{tabular}
\end{table}

% ========================================
% 5.5 Mitigação Automática
% ========================================

\subsection{Recomendações de Mitigação}
\label{sec:compliance:mitigation}

Quando violações são detectadas, DeepBridge sugere estratégias de mitigação:

\begin{lstlisting}[language=Python, caption=Recomendações de mitigação]
# Obter recomendacoes
recommendations = compliance_report.get_recommendations()

for issue in recommendations:
    print(f"\nIssue: {issue.regulation} - {issue.metric}")
    print(f"Current Value: {issue.current_value:.3f}")
    print(f"Required: {issue.threshold}")
    print("\nRecommended Actions:")
    for action in issue.actions:
        print(f"  {action.priority}: {action.description}")
        print(f"     Expected Impact: {action.expected_improvement}")
\end{lstlisting}

Exemplo de output:
\begin{lstlisting}[caption=Exemplo de recomendações]
Issue: EEOC 80% Rule - disparate_impact
Current Value: 0.76
Required: >= 0.80

Recommended Actions:
  HIGH: Rebalance training data
     Expected Impact: DI increase to 0.82-0.85
     Implementation: Use SMOTE or undersampling

  MEDIUM: Apply fairness constraints during training
     Expected Impact: DI increase to 0.80-0.82
     Implementation: Use fairlearn.reductions

  LOW: Adjust decision threshold per group
     Expected Impact: DI increase to 0.78-0.81
     Implementation: Use fairlearn.postprocessing
\end{lstlisting}

% ========================================
% 5.6 Continuous Compliance Monitoring
% ========================================

\subsection{Monitoramento Contínuo de Compliance}
\label{sec:compliance:monitoring}

Para modelos em produção, DeepBridge oferece monitoramento contínuo:

\begin{lstlisting}[language=Python, caption=Monitoramento contínuo]
from deepbridge.compliance import ComplianceMonitor

# Configurar monitor
monitor = ComplianceMonitor(
    model=production_model,
    regulations=['eeoc', 'ecoa'],
    check_frequency='daily',
    alert_on=['CRITICAL', 'WARNING']
)

# Registrar no pipeline de producao
@production_pipeline.hook('post_prediction')
def check_compliance(batch_data, predictions):
    # Avaliar compliance no batch
    status = monitor.check_batch(batch_data, predictions)

    if status.has_violations:
        # Enviar alerta
        alert_team(status.violations)

        # Logs estruturados
        logger.warning(
            "Compliance violation detected",
            extra={
                'regulation': status.violated_regulation,
                'metric': status.metric,
                'threshold': status.threshold,
                'actual': status.actual_value
            }
        )
\end{lstlisting}

% ========================================
% 5.7 Integração com MLOps
% ========================================

\subsection{Integração com MLOps}
\label{sec:compliance:mlops}

O Compliance Engine integra-se com ferramentas de MLOps para compliance automático em CI/CD:

\paragraph{MLflow Integration}
\begin{lstlisting}[language=Python, caption=Logging de compliance no MLflow]
import mlflow

with mlflow.start_run():
    # Treinar modelo
    model = train_model(X_train, y_train)

    # Validar compliance
    compliance = exp.check_compliance(regulations=['eeoc'])

    # Log no MLflow
    mlflow.log_metric('eeoc_disparate_impact', compliance.metrics['di'])
    mlflow.log_param('eeoc_80_rule_status', compliance.status)
    mlflow.log_artifact('compliance_report.pdf')

    # Gate: Bloquear deploy se nao-compliant
    if not compliance.is_compliant():
        raise ValueError("Model failed compliance check - blocking deployment")
\end{lstlisting}

\paragraph{CI/CD Gates}
\begin{lstlisting}[language=Bash, caption=Gate de compliance em CI/CD]
# .github/workflows/model-validation.yml
- name: Validate Compliance
  run: |
    deepbridge check-compliance \
      --model models/model.pkl \
      --data data/validation.csv \
      --regulations eeoc ecoa \
      --fail-on critical

    # Exit code 1 se compliance FAIL -> bloqueia merge
\end{lstlisting}

% ========================================
% 5.8 Sumário
% ========================================

\subsection{Sumário}
\label{sec:compliance:summary}

O \textit{Compliance Engine} do DeepBridge oferece:

\begin{enumerate}
    \item \textbf{Verificação Automática}: Primeiro framework a automatizar verificação de EEOC, ECOA, GDPR
    \item \textbf{Multi-Jurisdicional}: Suporte para US, EU, BR, CA com regras customizáveis
    \item \textbf{Audit-Ready Reports}: Relatórios formatados profissionalmente para auditorias
    \item \textbf{Continuous Monitoring}: Integração com pipelines de produção para compliance contínuo
    \item \textbf{Actionable Recommendations}: Sugestões priorizadas de mitigação
\end{enumerate}

Este componente preenche o gap crítico entre métricas acadêmicas de fairness e requisitos regulatórios práticos, reduzindo tempo de auditoria e riscos de não-conformidade.

A próxima seção (Seção~\ref{sec:hpmkd}) apresenta o HPM-KD Framework para \textit{knowledge distillation}, permitindo compressão de modelos com retenção de accuracy e fairness.
